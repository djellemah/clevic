<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <link rel="stylesheet" href="stylesheets/screen.css" type="text/css" media="screen" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>
      Clevic
  </title>
<style>

</style>
  <script type="text/javascript">
    window.onload = function() {
      settings = {
          tl: { radius: 10 },
          tr: { radius: 10 },
          bl: { radius: 10 },
          br: { radius: 10 },
          antiAlias: true,
          autoPad: true,
          validTags: ["div"]
      }
    }
  </script>
</head>
<body>

<div id="main">
	<h1>Clevic</h1>
	<p><a href="rdoc">RDoc</a> | <a href="http://rubyforge.org/projects/clevic/">Rubyforge Project</a></p>


	<p>Screenshot of a fully defined UI with the foreign-key dropdown in place. Tabs contain
the two tables, model definition file is below the screenshot. The Entry
model has some code to do update the credit and debit fields when
the new item description is found in the table.</p>


	<p><img src="screenshot.png" title="Screenshot" alt="Screenshot" /></p>


	<p>Code for minimal UI definition</p>


<pre><code>
require 'clevic.rb'

# see sql/accounts.sql for schema

# db connection
Clevic::DbOptions.connect do
  database 'accounts_test'
  adapter :postgresql
  username 'accounts'
end

# minimal definition to get combo boxes to show up
class Entry &lt; Clevic::Record
  belongs_to :debit, :class_name =&gt; 'Account', :foreign_key =&gt; 'debit_id'
  belongs_to :credit, :class_name =&gt; 'Account', :foreign_key =&gt; 'credit_id'
end

# minimal definition to get sensible values in combo boxes
class Account &lt; Clevic::Record
  def to_s; name; end
end

</code></pre>

	<p>Code for a full definition</p>


<pre><code>
require 'clevic.rb'

# db connection
Clevic::DbOptions.connect( $options ) do
  # use a different db for testing, so real data doesn't get broken.
  if options[:database].nil? || options[:database].empty?
    database( debug? ? :accounts_test : :accounts )
  else
    database options[:database]
  end
  adapter :postgresql
  username 'accounts'
end

class Entry &lt; Clevic::Record
  belongs_to :debit, :class_name =&gt; 'Account', :foreign_key =&gt; 'debit_id'
  belongs_to :credit, :class_name =&gt; 'Account', :foreign_key =&gt; 'credit_id'

  define_ui do
    plain       :date, :sample =&gt; '88-WWW-99'
    distinct    :description, :conditions =&gt; "now() - date &lt;= '1 year'", :sample =&gt; 'm' * 26
    relational  :debit, :display =&gt; 'name', :conditions =&gt; 'active = true', :order =&gt; 'lower(name)', :sample =&gt; 'Leilani Member Loan'
    relational  :credit, :display =&gt; 'name', :conditions =&gt; 'active = true', :order =&gt; 'lower(name)', :sample =&gt; 'Leilani Member Loan'
    plain       :amount, :sample =&gt; 999999.99
    distinct    :category
    plain       :cheque_number
    plain       :active, :sample =&gt; 'WW'
    plain       :vat, :label =&gt; 'VAT', :sample =&gt; 'WW', :tooltip =&gt; 'Does this include VAT?'

    records     :order =&gt; 'date, id'
  end

  # called when data is changed in the UI
  def self.data_changed( top_left, bottom_right, view )
    if top_left == bottom_right
      update_credit_debit( top_left, view )
    else
      puts "top_left: #{top_left.inspect}" 
      puts "bottom_right: #{bottom_right.inspect}" 
      puts "can't do data_changed for a range" 
    end
  end

  # check that the current field is :descriptions, then
  # copy the values for the credit and debit fields
  # from the previous similar entry
  def self.update_credit_debit( current_index, view )
    return unless current_index.valid?
    current_field = current_index.attribute
    if current_field == :description
      # most recent entry, ordered in reverse
      similar = self.find(
        :first,
        :conditions =&gt; ["#{current_field} = ?", current_index.attribute_value],
        :order =&gt; 'date desc'
      )
      if similar != nil
        # set the values
        current_index.entity.debit = similar.debit
        current_index.entity.credit = similar.credit
        current_index.entity.category = similar.category

        # emit signal to update view from top_left to bottom_right
        top_left_index = current_index.choppy( :column =&gt; 0 )
        bottom_right_index = current_index.choppy( :column =&gt; view.model.column_count - 1 )
        view.dataChanged( top_left_index, bottom_right_index )

        # move edit cursor to amount field
        view.selection_model.clear
        view.override_next_index( current_index.choppy( :column =&gt; view.field_column( :amount ) ) )
      end
    end
  end
end

class Account &lt; Clevic::Record  
  has_many :debits, :class_name =&gt; 'Entry', :foreign_key =&gt; 'debit_id'
  has_many :credits, :class_name =&gt; 'Entry', :foreign_key =&gt; 'credit_id'

  # define how fields are displayed
  define_ui do
    plain       :name
    restricted  :vat, :label =&gt; 'VAT', :set =&gt; %w{ yes no all }
    plain       :account_type
    plain       :pastel_number, :alignment =&gt; Qt::AlignRight, :label =&gt; 'Pastel'
    plain       :fringe, :format =&gt; "%.1f" 
    plain       :active

    records  :order =&gt; 'name,account_type'
  end
end

</code></pre>
</div>

<!-- insert site tracking codes here, like Google Urchin -->

</body>
</html>
